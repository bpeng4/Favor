---
title: "Log2_Heatmap"
output: html_document
date: "2025-05-14"
---

#Normalized ASV Table Preparation
```{r , eval=FALSE}
rm(list = ls())
gc()
suppressMessages({
  library("tidyverse")
  library("phyloseq")
  library("rstatix")
  library("vegan")
  library("picante")
  library("ggpubr")
  library(vegan)
  library(dplyr)
  library(tidyr)
  library(ggplot2)
  library(poppr)  # For AMOVA if genetic analysis is needed
  library(viridis)
  library(patchwork)
  library(pheatmap)
  library(RColorBrewer)
  library(agricolae)
  library(microbiomeSeq)
  library(microbiomeutilities)
  library(viridis)
  library(RColorBrewer)
})
no_of_cores = 16
setwd("/work/benson/bpeng4/Favor/Favor_16S")
load("intermediate/Favor_ps.rda")
ls()
ps

###Pre-arrangement on  the phyloseq file
################
ps.clean <- subset_taxa(ps, Kingdom == "Bacteria") %>%
  subset_taxa(!is.na(Phylum)) %>%
  subset_taxa(!Class %in% c("Chloroplast")) %>%
  subset_taxa(!Family %in% c("Mitochondria"))
ps.clean

## Standardize Data by Rarefication
##
#Check Total Reads to find the Thresholds for Rarefication
OTU<-otu_table(ps.clean) |>as.data.frame()
OTU$Total<- rowSums(OTU)
#Rarefication
ps.rare<-rarefy_even_depth(ps.clean, sample.size = 13154,
                           rngseed = 111, replace = TRUE, trimOTUs = TRUE, verbose = TRUE)

ps.genus = phyloseq::tax_glom(ps.rare, taxrank = rank_names(ps.rare)[6])
```



#Write a Function for Permanova Test Filteration
```{r}
ps.filter<-function(ps.genus){
  #Extract OTU/ASV table and metadata:
  otu_table <- as.data.frame(otu_table(ps.genus))
  metadata <- data.frame(sample_data(ps.genus))  # Force conversion
  taxa_table<- as.data.frame(tax_table(ps.genus))

  #Use the adonis function (PERMANOVA) from vegan to analyze treatment(Sample) effects
  metadata$Sample <- as.factor(metadata$Sample)  # Ensure it's a factor
  adonis_results <- adonis2(otu_table ~ Sample, data = metadata, permutations = 999, method = "bray")
  
  #Extract p-values
  p_value <- adonis_results$`Pr(>F)`[1]  # Extract p-value for treatment
  
  #test each taxon individually:
  p_values <- apply(otu_table, 2, function(x) {
    df <- data.frame(x = x, Sample = metadata$Sample)
    fit <- aov(x ~ Sample, data = df)
    summary(fit)[[1]][["Pr(>F)"]][1]  # Extract p-value
  })
  
  #Adjust for multiple testing (FDR correction):
  p_values_adj <- p.adjust(p_values, method = "fdr")
  
  #Mark taxa as significant if p < 0.05
  signif_taxa <- names(p_values_adj[p_values_adj < 0.05])

  #Filter for only the significant taxa
  ps.genus.filtered <- prune_taxa(taxa_names(ps.genus) %in% signif_taxa, ps.genus)
  
  return(ps.genus.filtered)
}
```


#Write a Function for plotting log2 fold Heatmap for Category
```{r, eval=FALSE}
heatmapsample <- function(ps.genus) {

  # Extract OTU (abundance) table and metadata from phyloseq
  otu_table_df <- as.data.frame(otu_table(ps.genus))
  meta_df <- as.data.frame(sample_data(ps.genus))
  
  # Add sample information to the OTU table
  otu_table_df$Sample <- meta_df$Sample[match(rownames(otu_table_df), rownames(meta_df))]
  
  # Aggregate by sample (mean abundance per sample)
  otu_table_avg <- otu_table_df %>%
    group_by(Sample) %>%
    summarise(across(where(is.numeric), mean, na.rm = TRUE))
  
  # Convert back to matrix and ensure row names are correct
  otu_table_avg <- column_to_rownames(otu_table_avg, var = "Sample") %>%
    as.matrix()
  
  # Convert back to a phyloseq OTU table
  otu_table_avg_phylo <- otu_table(otu_table_avg, taxa_are_rows = FALSE)
  
  # Ensure tax_table matches the taxa in otu_table_avg_phylo
  common_taxa <- intersect(rownames(tax_table(ps.genus)), colnames(otu_table_avg_phylo))
  tax_table_filtered <- tax_table(ps.genus)[common_taxa, ]
  
  # Create a new sample metadata table
  meta_avg_phylo <- sample_data(data.frame(Sample = rownames(otu_table_avg_phylo),
                                           row.names = rownames(otu_table_avg_phylo)))
  
  # Set factor levels for Sample in the desired order
  meta_avg_phylo$Sample <- factor(meta_avg_phylo$Sample, 
                                  levels = c("FBB0", "A554", "PHG47", "PHG39", "B57", "HP301",
                                             "LH60", "764", "PHG35", "NC262"))
  
  # Create a new phyloseq object with matching OTU and tax tables
  ps.genus.avg <- phyloseq(otu_table_avg_phylo, tax_table_filtered, meta_avg_phylo)
  
  # Step 2: Apply log2(x + 1)
  ps.genus.log2 <- transform_sample_counts(ps.genus.avg, function(x) log2(x + 1))

  # Step 3: Convert log2(x + 1) to 10^(log2(x + 1))
  ps.genus.log2.10 <- transform_sample_counts(ps.genus.log2, function(x) 10^x)
  
  # Plot heatmap of top 50 taxa
  heat.sample <- plot_taxa_heatmap(
    ps.genus.log2.10,
    subset.top = 50,
    VariableA = c("Sample"),
    heatcolors = colorRampPalette(rev(brewer.pal(n = 7, name = "RdYlBu")))(100),
    transformation = "log10"
  )
  
  return(heat.sample)
}


```

#Plot
ps.genus.filtered <- ps.filter(ps.genus)

heatmapsample(ps.genus.filtered)


